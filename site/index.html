<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baiko â€” Fiteny Fanaovana Programa</title>
  <link rel="stylesheet" href="style.css" />

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/theme/dracula.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/addon/hint/show-hint.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/addon/lint/lint.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/addon/mode/simple.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.17/addon/lint/lint.min.js"></script>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1><span class="logo">ðŸ‡²ðŸ‡¬</span> Baiko</h1>
      <p class="tagline">Fiteny fanaovana programa amin'ny teny malagasy</p>
    </div>
  </header>

  <main>
    <aside class="examples-panel">
      <h2>Ohatra</h2>
      <ul id="example-list">
        <li class="active" data-id="hello">Salama Baiko</li>
        <li data-id="calc">Kajy isa</li>
        <li data-id="cond">Raha / Ankoatra</li>
        <li data-id="loop">Fitodiavana</li>
        <li data-id="func">Asa</li>
        <li data-id="fizzbuzz">FizzBuzz</li>
        <li data-id="lisitra">Lisitra</li>
      </ul>
    </aside>

    <section class="editor-panel">
      <div class="editor-header">
        <span class="filename">main.baiko</span>
        <button id="run-btn">&#9654; Ampiasao</button>
      </div>
      <textarea id="editor"></textarea>
    </section>

    <section class="output-panel">
      <div class="output-header">
        <span>Vokatra</span>
        <button id="clear-btn">Fafao</button>
      </div>
      <pre id="output"></pre>
    </section>
  </main>

  <footer>
    <a href="https://github.com/narisrazafimahatratra/baiko" target="_blank" rel="noopener">GitHub</a>
    &nbsp;Â·&nbsp;
    <a href="https://www.npmjs.com/package/baiko" target="_blank" rel="noopener">npm</a>
  </footer>

  <script src="dist/baiko.js"></script>
  <script>
    // ---- Exemples ----
    const EXAMPLES = {
      hello: `# Salama Baiko !\nasehoy "Salama, Baiko!";\nasehoy 2 + 2;\n`,

      calc: `# Kajy tsotra\nx: Isa = 10;\ny: Isa = 32;\nvokatra: Isa = x + y;\nasehoy "Vokatra:";\nasehoy vokatra;\n`,

      cond: `# Raha / Ankoatra\nisa: Isa = 42;\nraha isa > 10 dia\n  asehoy "Lehibe noho ny 10";\nankoatra dia\n  asehoy "Kely noho ny 10";\nfarany\n`,

      loop: `# Fitodiavana (while)\nkaonty: Isa = 1;\navereno raha kaonty <= 5 dia\n  asehoy kaonty;\n  kaonty = kaonty + 1;\nfarany\n`,

      func: `# Asa (fonksiona)\nasa ampio(a: Isa, b: Isa): Isa dia\n  mamoaka a + b;\nfarany\n\nasa tohaina(s: Soratra): Soratra dia\n  mamoaka s + " - vita!";\nfarany\n\nvokatra: Isa = ampio(10, 32);\nasehoy vokatra;\nasehoy tohaina("Salama");\n`,

      fizzbuzz: `# FizzBuzz\nn: Isa = 1;\navereno raha n <= 20 dia\n  raha n - (n / 15) * 15 == 0 dia\n    asehoy "FizzBuzz";\n  ankoatra dia\n    raha n - (n / 3) * 3 == 0 dia\n      asehoy "Fizz";\n    ankoatra dia\n      raha n - (n / 5) * 5 == 0 dia\n        asehoy "Buzz";\n      ankoatra dia\n        asehoy n;\n      farany\n    farany\n  farany\n  n = n + 1;\nfarany\n`,

      lisitra: `# Lisitra (liste)\nnombres: Lisitra(Isa) = [10, 20, 30];\nasehoy nombres[0];\nnombres.ampidiro(40);\nasehoy nombres.isany;\nnombres[0] = 99;\nasehoy nombres;\n\n# ovay (map)\nasa roa(x: Isa): Isa dia\n  mamoaka x * 2;\nfarany\nasehoy nombres.ovay(roa);\n\n# tsingano (filter)\nasa lehibe(x: Isa): Marina dia\n  mamoaka x > 50;\nfarany\nasehoy nombres.tsingano(lehibe);\n\n# atambaro (reduce)\nasa manampy(acc: Isa, x: Isa): Isa dia\n  mamoaka acc + x;\nfarany\nasehoy nombres.atambaro(0, manampy);\n`,
    };

    // ---- Lint (surlignage d'erreurs) ----

    // Valeurs Baiko qui apparaissent dans les messages d'erreur mais ne pointent
    // pas vers une position utile (ex: "tsisy" dans "tsisy amin'ny >")
    const BAIKO_VALUE_KEYWORDS = new Set(["tsisy", "marina", "diso"]);

    // Cherche un token dans le code : word boundary pour les identifiants,
    // recherche littÃ©rale pour les opÃ©rateurs (+, >, <=, â€¦)
    function findTokenPos(code, name) {
      const escaped = name.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const isIdent = /^[a-zA-Z_]\w*$/.test(name);
      const re = new RegExp(isIdent ? "\\b" + escaped + "\\b" : escaped);
      const lines = code.split("\n");
      for (let i = 0; i < lines.length; i++) {
        const col = lines[i].search(re);
        if (col !== -1) return { line: i, col };
      }
      return null;
    }

    function baikoLint(code, updateLinting) {
      BaikoWeb.checkBaiko(code).then(function(errors) {
        updateLinting(errors.map(function(err) {
        let from, to;

        if (err.line !== null && err.col !== null) {
          // Position exacte depuis le message d'erreur (lexer/parser)
          const line = err.line - 1;
          const col  = err.col  - 1;
          const lineText = code.split("\n")[line] || "";
          let wordEnd = col;
          while (wordEnd < lineText.length && /\w/.test(lineText[wordEnd])) wordEnd++;
          from = CodeMirror.Pos(line, col);
          to   = CodeMirror.Pos(line, Math.max(col + 1, wordEnd));
        } else {
          // Essaie chaque terme entre guillemets (en ignorant les valeurs Baiko
          // comme "tsisy" qui ne correspondent pas Ã  une position utile)
          const allQuoted = [...err.message.matchAll(/"([^"]+)"/g)].map(function(m) { return m[1]; });
          const candidates = allQuoted.filter(function(t) { return !BAIKO_VALUE_KEYWORDS.has(t); });
          let found = false;
          for (const term of candidates) {
            const pos = findTokenPos(code, term);
            if (pos) {
              from  = CodeMirror.Pos(pos.line, pos.col);
              to    = CodeMirror.Pos(pos.line, pos.col + term.length);
              found = true;
              break;
            }
          }
          if (!found) {
            // Fallback : premiÃ¨re ligne
            from = CodeMirror.Pos(0, 0);
            to   = CodeMirror.Pos(0, (code.split("\n")[0] || "").length || 1);
          }
        }

        return { from, to, message: err.message, severity: "error" };
        }));
      });
    }

    CodeMirror.registerHelper("lint", "baiko", baikoLint);

    // ---- Autocomplete ----
    const BAIKO_KEYWORDS = [
      "asa", "andrasana", "raha", "ankoatra", "avereno raha", "mamoaka",
      "dia", "farany", "asehoy", "ary", "na", "tsy", "miandry", "ampidiro", "avoaka",
      "ovay", "tsingano", "atambaro", "isany",
      "marina", "diso", "tsisy", "Isa", "Soratra", "Marina", "Mety", "Lisitra",
    ];

    const LIST_MEMBERS = [
      { text: "ovay()",     displayText: "ovay(asa)            â€” map" },
      { text: "tsingano()", displayText: "tsingano(asa)        â€” filter" },
      { text: "atambaro()", displayText: "atambaro(init, asa)  â€” reduce" },
      { text: "ampidiro()", displayText: "ampidiro(singa)      â€” push" },
      { text: "isany",      displayText: "isany                â€” length" },
    ];

    function baikoHint(cm) {
      const cursor = cm.getCursor();
      const line = cm.getLine(cursor.line);
      let wordStart = cursor.ch;
      while (wordStart > 0 && /\w/.test(line[wordStart - 1])) wordStart--;
      const word = line.slice(wordStart, cursor.ch);

      // AutocomplÃ©tion aprÃ¨s un point : suggÃ¨re les mÃ©thodes si l'objet est Lisitra
      const beforeWord = line.slice(0, wordStart);
      const dotMatch = beforeWord.match(/([a-zA-Z_]\w*)\.$/);
      if (dotMatch) {
        const objName = dotMatch[1];
        const lisitraRe = new RegExp("\\b" + objName + "\\s*:\\s*Lisitra\\s*\\(");
        if (lisitraRe.test(cm.getValue())) {
          const filtered = LIST_MEMBERS.filter(function(entry) {
            return !word || entry.text.startsWith(word);
          });
          if (filtered.length === 0) return;
          return {
            list: filtered,
            from: CodeMirror.Pos(cursor.line, wordStart),
            to:   CodeMirror.Pos(cursor.line, cursor.ch),
          };
        }
      }

      if (!word) return;

      const text = cm.getValue();
      const userDefined = new Set();
      const fnRe  = /\basa\s+([a-zA-Z_]\w*)\s*\(/g;
      const varRe = /\b([a-zA-Z_]\w*)\s*:\s*(?:Mety\s*\(\s*)?(?:Lisitra\s*\([^)]*\)|Isa|Soratra|Marina)\b/g;
      let m;
      while ((m = fnRe.exec(text))  !== null) userDefined.add(m[1]);
      while ((m = varRe.exec(text)) !== null) userDefined.add(m[1]);

      const completions = [...BAIKO_KEYWORDS, ...userDefined].filter(k => k !== word && k.startsWith(word));
      if (completions.length === 0) return;
      return {
        list: completions,
        from: CodeMirror.Pos(cursor.line, wordStart),
        to:   CodeMirror.Pos(cursor.line, cursor.ch),
      };
    }

    CodeMirror.registerHelper("hint", "baiko", baikoHint);

    // ---- CodeMirror setup ----
    CodeMirror.defineSimpleMode("baiko", {
      start: [
        { regex: /#.*/, token: "comment" },
        { regex: /"(?:[^"\\]|\\.)*"/, token: "string" },
        { regex: /\b(?:avereno raha|asa|andrasana|miandry|raha|ankoatra|mamoaka|dia|farany|asehoy|ary|na|tsy|ampidiro|avoaka|ovay|tsingano|atambaro|isany)\b/, token: "keyword" },
        { regex: /\b(?:marina|diso|tsisy)\b/, token: "atom" },
        { regex: /\b(?:Isa|Soratra|Marina|Mety|Lisitra)\b/, token: "variable-2" },
        { regex: /\b\d+(?:\.\d+)?\b/, token: "number" },
        { regex: /[+\-*/<>=!]+/, token: "operator" },
        { regex: /[a-zA-Z_]\w*/, token: "variable" },
      ],
      meta: { lineComment: "#" },
    });

    const cm = CodeMirror.fromTextArea(document.getElementById("editor"), {
      mode: "baiko",
      theme: "dracula",
      lineNumbers: true,
      tabSize: 2,
      indentWithTabs: false,
      autofocus: true,
      gutters: ["CodeMirror-lint-markers"],
      lint: { getAnnotations: baikoLint, async: true, delay: 400 },
      extraKeys: {
        "Ctrl-Enter": runCode,
        "Cmd-Enter": runCode,
        "Ctrl-Space": function(editor) { editor.showHint({ hint: baikoHint, completeSingle: false }); },
      },
    });

    cm.on("inputRead", function(editor, change) {
      if (!change.text[0]) return;
      if (!/[a-zA-Z_.]/.test(change.text[0])) return;
      editor.showHint({ hint: baikoHint, completeSingle: false });
    });

    // ---- Exemples ----
    const exampleList = document.getElementById("example-list");
    exampleList.querySelectorAll("li").forEach(function(li) {
      li.addEventListener("click", function() {
        exampleList.querySelector(".active").classList.remove("active");
        li.classList.add("active");
        cm.setValue(EXAMPLES[li.dataset.id]);
        cm.focus();
      });
    });

    cm.setValue(EXAMPLES.hello);

    // ---- Run ----
    const output = document.getElementById("output");

    async function runCode() {
      const code = cm.getValue();
      output.textContent = "";
      output.className = "";
      try {
        const result = await BaikoWeb.runBaiko(code);
        output.textContent = result || "(tsy misy vokatra)";
        output.classList.add("ok");
      } catch (e) {
        output.textContent = "âš  " + e.message;
        output.classList.add("err");
      }
    }

    document.getElementById("run-btn").addEventListener("click", runCode);
    document.getElementById("clear-btn").addEventListener("click", function() {
      output.textContent = "";
      output.className = "";
    });
  </script>
</body>
</html>
